services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:${ELASTIC_VERSION}
    container_name: elasticsearch
    environment:
      # Bu parolalar hem ilk kurulum hem de setup servisi için gereklidir
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      - KIBANA_SYSTEM_PASSWORD=${KIBANA_SYSTEM_PASSWORD}
      - LOGSTASH_SYSTEM_PASSWORD=${LOGSTASH_SYSTEM_PASSWORD}
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - discovery.type=single-node
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ./elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
      - ./certs:/usr/share/elasticsearch/config/certs
      - es-data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    networks:
      - elk-net
    healthcheck:
      # Bu sağlık kontrolü, 'setup' servisinin ne zaman başlayacağını belirler
      test: ["CMD-SHELL", "curl -k -u elastic:${ELASTIC_PASSWORD} https://localhost:9200/_cluster/health | grep -q '\"status\":\"green\\|yellow\"'"]
      interval: 10s
      timeout: 10s
      retries: 60
      start_period: 60s

  setup:
    image: docker.elastic.co/elasticsearch/elasticsearch:${ELASTIC_VERSION}
    container_name: setup
    user: "0"
    environment:
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      - KIBANA_SYSTEM_PASSWORD=${KIBANA_SYSTEM_PASSWORD}
      - LOGSTASH_SYSTEM_PASSWORD=${LOGSTASH_SYSTEM_PASSWORD}
    command: >
      bash -c '
        echo "Waiting for Elasticsearch to be healthy..."
        # Elasticsearch sağlık kontrolünü geçene kadar bekle
        until curl -s -k -u "elastic:$${ELASTIC_PASSWORD}" https://elasticsearch:9200/_cluster/health 2>&1 | grep -q "yellow\|green"; do
          echo "Elasticsearch is unavailable - sleeping"
          sleep 5
        done
        
        echo "Elasticsearch is up - setting passwords"
        
        echo "Setting kibana_system password..."
        RESULT=$$(curl -X POST "https://elasticsearch:9200/_security/user/kibana_system/_password" \
          -k -u "elastic:$${ELASTIC_PASSWORD}" \
          -H "Content-Type: application/json" \
          -d "{\"password\":\"$${KIBANA_SYSTEM_PASSWORD}\"}" \
          -w "\n%{http_code}" -s)
        
        HTTP_CODE=$$(echo "$$RESULT" | tail -n1)
        if [ "$$HTTP_CODE" -eq 200 ]; then
          echo "✓ kibana_system password set successfully!"
        else
          echo "✗ Failed to set kibana_system password. HTTP Code: $$HTTP_CODE"
          echo "Response: $$RESULT"
          exit 1
        fi
        
        echo "Setting logstash_system password..."
        RESULT=$$(curl -X POST "https://elasticsearch:9200/_security/user/logstash_system/_password" \
          -k -u "elastic:$${ELASTIC_PASSWORD}" \
          -H "Content-Type: application/json" \
          -d "{\"password\":\"$${LOGSTASH_SYSTEM_PASSWORD}\"}" \
          -w "\n%{http_code}" -s)
        
        HTTP_CODE=$$(echo "$$RESULT" | tail -n1)
        if [ "$$HTTP_CODE" -eq 200 ]; then
          echo "✓ logstash_system password set successfully!"
        else
          echo "✗ Failed to set logstash_system password. HTTP Code: $$HTTP_CODE"
          echo "Response: $$RESULT"
          exit 1
        fi
        
        echo "✓ All passwords configured successfully!"
      '
    networks:
      - elk-net
    depends_on:
      elasticsearch:
        condition: service_healthy

  kibana:
    image: docker.elastic.co/kibana/kibana:${ELASTIC_VERSION}
    container_name: kibana
    user: "0" 
    command: ["kibana", "--allow-root"]
    environment:
      - KIBANA_SYSTEM_PASSWORD=${KIBANA_SYSTEM_PASSWORD}
    volumes:
      - ./kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml
      - ./certs/elastic-stack-ca.crt:/usr/share/kibana/config/certs/elastic-stack-ca.crt
    ports:
      - "5601:5601"
    networks:
      - elk-net
    depends_on:
      setup:
        condition: service_completed_successfully

  logstash:
    image: docker.elastic.co/logstash/logstash:${ELASTIC_VERSION}
    container_name: logstash
    user: "1000:0" # User 1000 (logstash), Group 0 (root)
    environment:
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      - LOGSTASH_SYSTEM_PASSWORD=${LOGSTASH_SYSTEM_PASSWORD}
      - GMAIL_USERNAME=${GMAIL_USERNAME}
      - GMAIL_APP_PASSWORD=${GMAIL_APP_PASSWORD}
      - TZ=Europe/Istanbul
    volumes:
      - ./logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml
      - ./logstash/config/pipelines.yml:/usr/share/logstash/config/pipelines.yml
      - ./logstash/pipeline:/usr/share/logstash/pipeline
      - ./certs/elastic-stack-ca.crt:/usr/share/logstash/config/certs/elastic-stack-ca.crt
    ports:
      - "5044:5044"
      - "5045:5045"
    networks:
      - elk-net
    depends_on:
      setup:
        condition: service_completed_successfully

  filebeat:
    image: docker.elastic.co/beats/filebeat:${ELASTIC_VERSION}
    container_name: filebeat
    user: "0" 
    volumes:
      # :ro (read-only) ekini kaldırıyoruz ki chmod komutu çalışabilsin
      - ./filebeat/config/filebeat.yml:/usr/share/filebeat/filebeat.yml
      
      # Fortinet modülünü ekliyoruz
      - ./filebeat/modules.d:/usr/share/filebeat/modules.d:ro
      
      # SSL sertifikasını bağlıyoruz
      - ./certs/elastic-stack-ca.crt:/usr/share/filebeat/certs/elastic-stack-ca.crt:ro
      
      # Host makinedeki log dizinlerini konteynere bağlıyoruz
      - ./logs/nginx:/var/log/nginx:ro
      - ./logs/java-app:/var/log/java-app:ro
      
      # Filebeat'in kendi verilerini tutması için
      - filebeat-data:/usr/share/filebeat/data
      
    # --- DEĞİŞİKLİK 1 (command:) ---
    command: >
      bash -c "
        echo 'Fixing file permissions...';
        
        # Modüllerin kurulması için bir kerelik kurulum komutu
        filebeat setup -e
        
        
        # filebeat.yml için izinleri 
        chmod go-w /usr/share/filebeat/filebeat.yml;
        
        # fortinet.yml için izinleri  (Loglarda tespit edilen izin hatası için)
        chmod go-w /usr/share/filebeat/modules.d/fortinet.yml;
        
        
        echo 'Starting Filebeat...';
        filebeat -e
      "
      
    networks:
      - elk-net
      
    # --- DEĞİŞİKLİK 2 (ports:) ---
    ports:
      - "9004:9004/udp"
      
    depends_on:
      logstash:
        condition: service_started

networks:
  elk-net:
    driver: bridge

volumes:
  es-data:
    driver: local
  filebeat-data:
    driver: local