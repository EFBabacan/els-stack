input {
  beats {
    port => 5044
    type => "nginx"
  }
}

filter {
  # Sadece nginx tipindeki logları işle
  if [type] == "nginx" or "nginx" in [tags] {
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
      remove_field => ["message"]
    }
    
    date {
      match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
      target => "@timestamp"
    }
    
    if [agent] {
      useragent {
        source => "agent"
        target => "user_agent"
      }
    }
    
    if [clientip] {
      geoip {
        source => "clientip"
        target => "geoip"
      }
    }
    
    # Response code'u number'a çevir
    mutate {
      convert => { "response" => "integer" }
      convert => { "bytes" => "integer" }
    }
  }
}

output {
  if [type] == "nginx" or "nginx" in [tags] {
    elasticsearch {
      hosts => ["https://elasticsearch:9200"]
      ssl_certificate_authorities => ["/usr/share/logstash/config/certs/elastic-stack-ca.crt"]
      ssl_verification_mode => "none"
      manage_template => false
      user => "elastic"
      password => "${ELASTIC_PASSWORD}" 
      index => "nginx-logs-%{+YYYY.MM.dd}"
    }
    
    # Debug - konsola yazdır
    stdout {
      codec => rubydebug {
        metadata => true
      }
    }
  }
}