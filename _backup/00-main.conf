input {
  beats {
    port => 5044
    ssl => false
  }
}

filter {
  # Timestamp parsing
  date {
    match => ["@timestamp", "ISO8601"]
    timezone => "Europe/Istanbul"
    target => "@timestamp"
  }
  
  # Windows Logon eventleri
  if [winlog][task] == "Logon" {
    mutate {
      add_field => { "custom_index_name" => "windows-logon-logs" }
    }
    
    # Ba≈üarƒ±sƒ±z login tespiti
    if [winlog][event_data][LogonGuid] =~ /^(\{)?00000000-0000-0000-0000-000000000000/ {
      mutate {
        add_field => { "alert_type" => "failed_logon_attempt" }
        add_tag => ["security_alert", "send_email"]
      }
    }
  }
  
  # Windows Update Agent eventleri
  else if [winlog][task] == "Windows Update Agent" {
    mutate {
      add_field => { "custom_index_name" => "windows-update-logs" }
    }
    
    if [winlog][level] == "Error" or [winlog][level] == "Critical" {
      mutate {
        add_field => { "alert_type" => "windows_update_error" }
        add_tag => ["windows_update_error"]
      }
    }
  }
  
  # Windows Defender eventleri
  else if [event][provider] == "Microsoft-Windows-Windows Defender" {
    mutate {
      add_field => { "custom_index_name" => "windows-defender-logs" }
    }
    
    # Malware detection
    if [winlog][event_id] in [1116, 1117, 1118, 1119] {
      mutate {
        add_field => { "alert_type" => "malware_detected" }
        add_tag => ["security_alert", "send_email"]
      }
    }
  }
  
  # Windows Service Stop (Kritik!)
  else if [agent][type] == "metricbeat" and
          [event][dataset] == "windows.service" and
          [windows][service][state] == "Stopped" and
          [windows][service][start_type] == "Disabled" {
    mutate {
      add_field => {
        "custom_index_name" => "windows-service-alerts"
        "alert_type" => "windows_service_stopped"
      }
      add_tag => ["security_alert", "send_email"]
    }
  }
  
  # Fortinet Firewall eventleri
  else if [event][module] == "fortinet" {
    mutate {
      add_field => { "custom_index_name" => "fortinet-firewall-logs" }
    }
  }
  
  # File Integrity Monitoring (FIM)
  else if [agent][type] == "auditbeat" and
          [event][module] == "file_integrity" and
          [file][drive_letter] == "D" {
    mutate {
      add_field => {
        "custom_index_name" => "file-integrity-logs"
        "alert_type" => "file_integrity_alert"
      }
      add_tag => ["security_alert", "send_email"]
    }
  }
  
  # Diƒüer t√ºm loglar
  else {
    mutate {
      add_field => { "custom_index_name" => "general-logs" }
    }
  }
  
  # Email body hazƒ±rlama (sadece "send_email" tag'i olanlar i√ßin)
  if "send_email" in [tags] {
    ruby {
      code => '
        require "time"
        
        begin
          time_stamp = Time.parse(event.get("@timestamp").to_s).strftime("%d.%m.%Y %H:%M:%S")
        rescue
          time_stamp = Time.now.strftime("%d.%m.%Y %H:%M:%S")
        end
        
        alert_type = event.get("[alert_type]").to_s
        
        case alert_type
        when "failed_logon_attempt"
          email_subject = "üî¥ G√úVENLIK UYARISI: Ba≈üarƒ±sƒ±z Login Denemesi"
        when "malware_detected"
          email_subject = "üö® KRITIK: Malware Tespit Edildi!"
        when "windows_service_stopped"
          email_subject = "‚ö†Ô∏è UYARI: Windows Servisi Durduruldu"
        when "file_integrity_alert"
          email_subject = "‚ö†Ô∏è DOSYA DEƒûI≈ûIKLIƒûI: FIM Alert"
        else
          email_subject = "‚ÑπÔ∏è ELK Stack Bildirimi"
        end
        
        computer = event.get("[agent][name]") || event.get("[host][name]") || "N/A"
        
        # IP adresini d√ºzg√ºn al
        host_ip_raw = event.get("[host][ip]")
        if host_ip_raw.is_a?(Array)
          host_ip = host_ip_raw.join(", ")
        else
          host_ip = host_ip_raw || "N/A"
        end
        
        username = event.get("[winlog][event_data][TargetUserName]") || event.get("[user][name]") || "N/A"
        
        email_body = "
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 20px; }
              .container { background-color: white; border-radius: 5px; padding: 20px; max-width: 600px; margin: 0 auto; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
              h2 { color: #d32f2f; margin-top: 0; }
              table { border-collapse: collapse; width: 100%; margin-top: 20px; }
              th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
              th { background-color: #f44336; color: white; }
              .critical { background-color: #ffebee; }
              .footer { margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px; }
            </style>
          </head>
          <body>
            <div class=\\"container\\">
              <h2>#{email_subject}</h2>
              <p>ELK Stack sisteminde bir g√ºvenlik olayƒ± tespit edildi:</p>
              <table>
                <tr><th>√ñzellik</th><th>Deƒüer</th></tr>
                <tr class=\\"critical\\">
                  <td><b>Alert Tipi</b></td>
                  <td>#{alert_type}</td>
                </tr>
                <tr>
                  <td><b>Bilgisayar</b></td>
                  <td>#{computer}</td>
                </tr>
                <tr>
                  <td><b>IP Adresi</b></td>
                  <td>#{host_ip}</td>
                </tr>
                <tr>
                  <td><b>Kullanƒ±cƒ±</b></td>
                  <td>#{username}</td>
                </tr>
                <tr>
                  <td><b>Zaman</b></td>
                  <td>#{time_stamp}</td>
                </tr>
                <tr>
                  <td><b>Index</b></td>
                  <td>#{event.get("[custom_index_name]") || "N/A"}</td>
                </tr>
              </table>
              <div class=\\"footer\\">
                <p><i>Bu otomatik bir bildirimdir. Detaylƒ± inceleme i√ßin Kibana\\'ya giri≈ü yapƒ±n.</i></p>
                <p>Kibana: <a href=\\"http://localhost:5601\\">http://localhost:5601</a></p>
              </div>
            </div>
          </body>
          </html>
        "
        
        event.set("[@metadata][email_subject]", email_subject)
        event.set("[@metadata][email_body]", email_body)
      '
    }
  }
}

output {
  # Email g√∂nderimi (sadece "send_email" tag'i olanlar i√ßin)
  if "send_email" in [tags] {
    email {
      to => "ens.frkns@gmail.com"
      from => "elk-stack-alerts@gmail.com"
      subject => "%{[@metadata][email_subject]}"
      htmlbody => "%{[@metadata][email_body]}"
      
      address => "smtp.gmail.com"
      port => 587
      username => "${GMAIL_USERNAME}"
      password => "${GMAIL_APP_PASSWORD}"
      use_tls => true
      debug => true
    }
  }
  
  # Elasticsearch output (T√úM loglar)
  elasticsearch {
    hosts => ["https://elasticsearch:9200"]
    index => "%{[custom_index_name]}-%{+YYYY.MM.dd}"
    
    # SSL ayarlarƒ± - deprecation uyarƒ±larƒ±nƒ± d√ºzelt
    ssl_enabled => true
    ssl_certificate_authorities => ["/usr/share/logstash/config/certs/elastic-stack-ca.crt"]
    ssl_verification_mode => "none"
    
    user => "elastic"
    password => "${ELASTIC_PASSWORD}"
    
    ilm_enabled => false
  }
  
  # Console output (debug i√ßin)
  stdout {
    codec => rubydebug {
      metadata => false
    }
  }
}