input {
  pipeline {
    address => "nginx_pipeline"
  }
}

filter {
  grok {
    match => { "message" => "%{COMBINEDAPACHELOG}" }
  }

  date {
    match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
    target => "@timestamp"
  }

  # --- DÜZELTME BURADA ---
  # "agent" alanı Filebeat metadata'sıdır. Gerçek veri [user_agent][original] içindedir.
  if [user_agent][original] and [user_agent][original] != "-" {
    useragent {
      source => "[user_agent][original]"
      target => "user_agent"
    }
  }

  mutate {
    convert => { 
      "response" => "integer"
      "bytes"    => "integer"
    }

    add_field => { "[@metadata][target_index]" => "nginx-logs" }

    remove_field => [
      "message", 
      "timestamp", 
      "ecs", 
      "host", 
      "event", 
      "log", 
      "input"
    ]
  }
}

output {
  pipeline {
    send_to => ["es_output_channel"]
  }
}